<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HR Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
    }
    .navbar-custom {
      background-color: #007bff;
    }
    .search-input {
      width: 500px;
    }
    .sidebar {
      height: 100vh;
      width: 250px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0px 10px rgba(0, 0, 0, 0.1);
    }
    .sidebar .nav-link {
      color: #333;
      font-weight: 500;
    }
    .sidebar .nav-link:hover {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 5px;
    }
    .card-custom {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-custom text-white">
    <a class="navbar-brand text-white" href="{% url 'hr_dashboard' %}">HR Dashboard</a>
    <div class="collapse navbar-collapse">
      <form class="form-inline mx-auto">
        <input class="form-control search-input" type="search" placeholder="Search Employee..." aria-label="Search">
        <button class="btn btn-light ml-2" type="submit">Search</button>
      </form>
    </div>
    <a href="{% url 'logout' %}" class="btn btn-outline-light">Logout</a>
  </nav>

<div class="container mt-4">
    <h2 class="mb-4">Leave Requests</h2>

    <!-- Search & Filter -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by employee name..." onkeyup="searchTable()">
        </div>
        <div class="col-md-3">
            <select class="form-control" id="filterStatus" onchange="filterTable()">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>
    </div>

    <!-- Leave Requests Table -->
    <div class="card glass-card p-3">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Employee Id</th>
                    <th>Name</th>
                    <th>Leave Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for leave in leave_requests %}
                <tr class="leave-row" data-status="{{ leave.status }}">
                    <td>{{ leave.employee.name }}</td>
                    <td>{{ leave.leave_type }}</td>
                    <td>{{ leave.start_date }}</td>
                    <td>{{ leave.end_date }}</td>
                    <td>
                        <span class="badge {% if leave.status == 'Approved' %}badge-success{% elif leave.status == 'Rejected' %}badge-danger{% else %}badge-warning{% endif %}">
                            {{ leave.status }}
                        </span>
                    </td>
                    <td>
                        {% if leave.status == 'Pending' %}
                            <button class="btn btn-success btn-sm approve-btn" data-id="{{ leave.id }}">Approve</button>
                            <button class="btn btn-danger btn-sm reject-btn" data-id="{{ leave.id }}">Reject</button>
                        {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>{{ leave.status }}</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No leave requests found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Leave Request</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="leaveId">
                <textarea id="rejectReason" class="form-control" rows="3" placeholder="Enter rejection reason..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="rejectLeave()">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Search, Filter, Approve, Reject -->
<script>
    function searchTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll(".leave-row");
        rows.forEach(row => {
            let name = row.cells[0].innerText.toLowerCase();
            row.style.display = name.includes(input) ? "" : "none";
        });
    }

    function filterTable() {
        let filter = document.getElementById("filterStatus").value;
        let rows = document.querySelectorAll(".leave-row");
        rows.forEach(row => {
            row.style.display = (!filter || row.dataset.status === filter) ? "" : "none";
        });
    }
    document.querySelectorAll(".approve-btn").forEach(button => {
        button.addEventListener("click", function() {
            let leaveId = this.getAttribute("data-id");
            approveLeave(leaveId);
        });
    });
    document.querySelectorAll(".reject-btn").forEach(button => {
        button.addEventListener("click", function() {
            let leaveId = this.getAttribute("data-id");
            approveLeave(leaveId);
        });
    });

    function approveLeave(leaveId) {
        fetch(`/approve_leave/${leaveId}/`, { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
            .then(() => location.reload());
    }

    function openRejectModal(leaveId) {
        document.getElementById("leaveId").value = leaveId;
        $("#rejectModal").modal("show");
    }

    function rejectLeave() {
        let leaveId = document.getElementById("leaveId").value;
        let reason = document.getElementById("rejectReason").value;
        fetch(`/reject_leave/${leaveId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ reason: reason })
        }).then(() => location.reload());
    }
</script>
</body>
</html>
